---
title: "Methodological advancements on the use of administrative data in Official Statistics - User Manual 1"
output:
  word_document:
    toc: true  
date: "Dec 2022"    
editor_options:
  markdown:
    wrap: 68
---
  <!-- html_document: -->
  <!--   toc: true -->
  <!--   toc_float: true -->
  <!--   theme: yeti -->
Dec 2022

# A Brief Introduction

Using administrative data in Official Statistics needs caution due
to the uncertainly surrounding the quality of the administrative
data. This manual guides you through implementing R code files to
obtain quality measures of the target administrative data. The
quality measures consist of two elements: distance metrics and
R-indicators. Please consult here [add link] for more details on the
distance metrics and R-indicators.

This space is strictly reserved to walk through obtaining distance
metrics and R-indicators.

# Download and inspect the contents

## 1 Download

Please visit the github site here: [github link](). Click on xxx to
download.

Now, the downloaded folder needs to be placed in the meaningful
location. We recommend users decide the appropriate Drive (C, D, E,
F, etc) to house the downloaded contents. Then, **create a new
folder** called `admindata` in File Explorer of your PC. Users can
customise the new folder name as appropriate. This is your
**starting path**.

The screenshot showing **starting path**:

![Starting_path](User_manual/Starting_path.png) 

Under this Starting path,
`F:/admindata`, place the downloaded folder from GitHub. Extract the
zip folder as necessary.

As such, `F:/admindata/Public_Release` becomes the MASTER project
folder. We'll set it as working directory in RStudio later.

> Notice that the terms, folder, directory, and path are used
> interchangeably in the user manual.

## 2 Downloaded contents explained

### Example datasets

We provide two example data sources.


| Data type       | File name                          |
|-----------------|------------------------------------|
| Administrative  | public_release_admin.csv           |
| Census          | pop_u_short_before_sim_5vars.Rdata |

### Folders and R scripts

Under `F:\admindata\Public_Release` folder, you'll be presented with
the following contents.
![contents](User_manual/Contents_v2.png)

The **"User_manual"** folder contains instructions on using the
provided R code files.

The users do not need to do anything with the folder titled
**"Functions"**. These pre-defined functions are used to either
enclose complex procedures or perform repetitive tasks including
cleaning and computing quality indicators. There are two files
containing pre-defined functions. There is no need to run function
files independently.

The functions will be automatically called in when the three main R
script files are run: `2_Prep_Wtsample_Freq_Table.R`
`3_A_Distance_Metrics.R` `3_B_R-indicator.R`

The `2_Prep_Wtsample_Freq_Table.R` file creates necessary data
needed to compute distance metrics and R-indicators. The master
file, `3_MASTER_Run_AB.R` runs the above *two* main R script files, (`3_A_Distance_Metrics.R` `3_B_R-indicator.R`)
automatically in sequence.

The first three files, `0_Custom_Path.R`, `1_Create_Folders.R` and
`1_Install_Packages.R` can be run to get ready to run the above main
analysis files, as discussed in the following section.

# Launch RStudio and get ready

## 1 Open the entire master folder in RStudio

First, launch RStudio. Then, we need to **open the entire folder**
`F:/admindata/Public_Release` where downloaded materials are
located.

Unfortunately, RStudio has no feature in the menu, but you could do
so by accessing **Files** tab. Click on `...` as shown below. ![Open
folder](User_manual/Open_folder.png) Then, locate the master folder.
In our example, it is `F:/admindata/Public_Release`.

## 2 Set custom path

Click open the R script file, `0_Custom_Path.R`. Customise the
starting path as needed, and set the path to indicate the master
folder. The example code is:

```{r, eval=F}
    # Starting path (CUSTOMISE PLEASE)
    setwd("F:/admindata")

    # Master project folder (USE AS IT IS)
    setwd("./Public_Release")

    # Check your current directory
    getwd()
```

Please ensure to use a single forward slash `/` as above. R will
print an error when backward slash `\` is used in path. For
instance,

```{r, eval= F}
    setwd("F:\admindata)`
    Error: '\a' is an unrecognized escape in character string starting ""F:\a"
```

> Please ensure your working directory is set at the master project
path throught the analytical steps.

## 3 Automatically create output folders

The three main R script files `2_Prep_Wtsample_Freq_Table.R`,
`3_A_Distance_Metrics.R`, `3_B_R-indicator.R` produce outputs. The
outputs may be text, figure or in spreadsheet form. For the existing
programmes to work, users need to create dedicated output folders.

To do so, please click on the `1_Create_Folders.R` file to open.
Then run line by line. The resulting folder structure is provided here:

![Outputs_folder](User_manual/Outputs_folder.png)

## 4 Install packages

The final preparation step is installing packages. Open
`1_Install_Packages.R` file, and run line by line.
```{r, eval = F, include = T}
        #-----------------------------------
        # Install packages (Run once)
        #-----------------------------------
        
        install.packages("ggplot2")
        install.packages("tidyverse")
        
        install.packages("car")
```

Now, you're all set to proceed with quality measures
indicators!

If you need technical support, please consult Q & A.  

# Q & A

## How do I know where to customise the code to suit my needs?
Unless indicated as "Customise as needed", users can run the code as it is. Please consult each code file.

## How to use **Starting path** in multiple machines?
 If users plan to use different machines, simply by changing the "starting path", users can carry out the analysis with minimal disruption. To achieve this, please ensure to use the consistent master project folder name.

## What are the commonly used commands?
Most commonly used commands in the tidyverse package are:
```
  arrange : sort variables.
  bind_rows: append multiple dataframes.
  mutate  : manipulate variables, and
            create new variables based on old variables.
  select  : order, and keep(drop) variables of interest.
  shell.exec: launch a software and opens the target file (Windows PC only)
```

### How to free up memory space and speed up RStudio?
You can remove objects that you no longer need.
```
  # To remove objects except for certain objects
  ls()
  keepobjectslist <- c("a", "b", "c")
  rm(list = ls()[!ls() %in% keepobjectslist])
  ls()
```

### I get error messages when a pre-defined function is used.
Users can inspect the codes used in the function, and identify the issues. It is recommended NOT edit the function file directly, as the functions are used repeatedly, and the interlinked sections may not run as expected. Where preferable, users may copy the codes in the function, and use locally with minor tweaks.

## How do I modify pre-defined functions?
Users can modify `1_Functions` and `2_Functions_R-indicators.R` under *Functions* folder. 
```{r}
# 1_Functions.R
fn_output_folder_path <- function() {

  currentdate <<- Sys.Date()
  txtpath   <<- "Output/01-Txt/"
  figpath   <<- "Output/02-Figure/"
  xlsxpath  <<- "./Output/03-ExcelOutput/"
  Rdatapath <<- "Output/04-RData/"
}
```
We can check how the output folder names are set as path to save the results during the analytical process. 
```{r}
fn_output_folder_path()
```
Let's run the function. We can see that xlsxpath is set as `"./Output/03-ExcelOutput/"`. 
```{r}
xlsxpath
```
Let's customise the xlsxpath, by renaming the folder name. If we customise `1_Functions.R` file, we can edit the information enclosed in the brackets. Notice that we use `<<-` with functions so that the object created by a function will exist in the global R environment. This is very important.

Alternatively, We could ignore the pre-defined function and just write relevant lines of code and keep it in the 
main R script file. For instance, we could put output_folder_path at the top of the `2_Prep_Wtsample_Freq_Table.R`. Here, we edited the `xlsxpath`. Notice that `fn_output_folder_path <- function() {  }` is removed.
```{r}
    xlsxpath_2 <- "./Output/03-Excel/"
    
    xlsxpath_2
    #H---------------------------------------
    ## > Step 1. Load Census data
    #H--------------------------------------
    # load("pop_u_short_before_sim_5vars.RData")
```
Notice that we use `<-`. Using `<<-` is not necessary here. Users can remember the usage of `<-` and can modify the functions as appropriate, should the function incurs errors.

## Technial notes and programming strategies
When loop is used, base R functions were used (table, tapply, etc). For data manipulation, tidyverse package was used extensively. This strategy is partly to improve readability of the code.

To enhance users' workflow, output files are programmed to launch using the pre-defined functions.

## Can I ignore Warning messages?
Some packages alert users with compatibility issues arising from old version. These can be ignored.
For example,
```
  library("fastDummies")
  Warning message:
  package 'fastDummies' was built under
  R version 4.1.2

  library(rlist)
  Warning message:
  package 'rlist' was built under R version 4.1.2
```
## Troubleshooting

### Unused argument error
For example, `sim %>% select(geog1a)`
the select command can cause an error:
```
Error in select(., geog1a) :
  unused arguments (geog1a)
```
This maybe due to the conflict in packages.

The error can be fixed by adding the name of the
package used, dplyr, explicitly.
`sim %>% dplyr::select(geog1a)`

### I get errors when computing...
Please inspect zero cells, and ensure 0 (numeric value) is entered for n and perc, as well as admin_n and admin_perc. Errors may occur with NA coding and data attributes(character, factor, numeric).


## I am experiencing slowness in computation.
R can be not responsive if memory is full.
Please identify bottlenecks and remove them. It may be due to certain commands.
For example, `View(object)` command could take a while if the object is huge in size. Unless one should inspect the data, suppress the View command to expedite the computation where possible. 

It can also be the case that for loop functions can be slow as well. In some instances, removing objects may help as this procedure can free up memory space. See above commonly used commands for more information.

## Error: cannot allocate vector of size xxxx.x Gb
If matrix symbols have entered mistakenly, R shows an error message like this. Please double check whether there are any mistakes. For instance, one may have typed `a*b` instead of `a%*%b`.
Users can type
  `memory.limit()`
to check the current memory limit and increase as necessary.

# What version of R is used?
Tested with Windows PC. R version used: 4.1.1
RStudio version: RStudio 2022.07.2 Build 576
  
# References
  R Core Team (2022). R: A language and
  environment for statistical
  computing. R Foundation for
  Statistical Computing, Vienna,
  Austria. URL
  https://www.R-project.org/.

# Citation
Please cite this work as: TO BE COMPLETED  

<!-- End -->

